services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    network_mode: host

  livekit:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    network_mode: host
    env_file: .env
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    command: --config /etc/livekit.yaml
    depends_on:
      - redis

  ingress:
    image: livekit/ingress:latest
    restart: unless-stopped
    network_mode: host
    env_file: .env
    environment:
      INGRESS_CONFIG_BODY: |
        api_key: ${LIVEKIT_API_KEY}
        api_secret: ${LIVEKIT_API_SECRET}
        ws_url: ws://localhost:7880
        redis:
          address: localhost:6379
        rtmp_port: 1935
        http_relay_port: 9090
        logging:
          level: info
    depends_on:
      - redis
      - livekit

  caddy:
    image: caddy:latest
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - livekit

volumes:
  caddy_data:
  caddy_config:
